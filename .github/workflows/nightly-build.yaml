
name: Nightly Build

on:

  # Run this workflow manually from Actions tab
  workflow_dispatch:
    inputs:
      branch_to_test:
        description: 'Branch or tag to build'
        required: true
        default: 'dev_main'
        type: string

# Allow one concurrent deployment
concurrency:
  group: ${{ github.repository }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:

  nightly-build:

    runs-on: ubuntu-latest
    timeout-minutes: 40
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-southeast-1

      - name: S3 test
        run: |
          aws s3 ls ${{ vars.AWS_S3_PATH }}
          echo "This job's status is ${{ job.status }}."

      # Deploy moonshot

      - name: Backup current deploy
        run: |
          command_id=$(aws ssm send-command \
            --instance-ids "${{ vars.AWS_SIT_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Backup current deploy" \
            --parameters 'commands=["sudo su - ubuntu -c \"mv moonshot moonshot-bak && mkdir moonshot\""]' \
            --query "Command.CommandId" \
            --output text)
        # Wait for the command to complete
          aws ssm wait command-executed \
            --command-id "$command_id" \
            --instance-id "${{ vars.AWS_SIT_INSTANCE_ID }}"
        # Check the final status of the command
          status=$(aws ssm list-command-invocations \
            --command-id "$command_id" \
            --details \
            --query "CommandInvocations[0].Status" \
            --output text)
          echo "Command status: $status"
